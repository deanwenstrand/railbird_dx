type: test
name: automation_contact_capture_slack
description: Test contact capture Slack automation for form submissions

scenarios:
  - name: sends_slack_notification_on_contact_form
    description: Should send Slack notification when contact form is submitted
    given:
      - clear_automation_logs: []
    when:
      - call:
          method: POST
          path: "/api/form_submissions"
          body:
            form_name: "website_contact_us"
            visitor_id: "slack_test_visitor_123"
            referrer_url: "https://example.com/contact"
            form_data:
              name: "Slack Test User"
              email: "slacktest@test.com"
              company: "Slack Test Corp"
              message: "Interested in your platform"
          capture: submission_id
      - wait_until:
          source: automation_log
          timeout_ms: 10000
          interval_ms: 500
          match:
            automation_id: contact_capture_slack
            status: completed
          capture: completion_event
    then:
      - expect: completion_event.automation_id
        operator: "=="
        value: "contact_capture_slack"
      - expect: completion_event.status
        operator: "=="
        value: "completed"

  - name: formats_slack_message_correctly
    description: Should format Slack message with form data
    given:
      - clear_automation_logs: []
    when:
      - call:
          method: POST
          path: "/api/form_submissions"
          body:
            form_name: "website_contact_us"
            visitor_id: "format_test_visitor_456"
            referrer_url: "https://example.com/pricing"
            form_data:
              name: "Format Test"
              email: "format@test.com"
              company: "Format Corp"
              phone: "+1-555-9999"
          capture: submission_id
      - wait_until:
          source: automation_log
          timeout_ms: 10000
          interval_ms: 500
          match:
            automation_id: contact_capture_slack
            step_type: action
            action_type: integration_call
          capture: slack_action_event
    then:
      - expect: slack_action_event.automation_id
        operator: "=="
        value: "contact_capture_slack"
      - expect: slack_action_event.action_type
        operator: "=="
        value: "integration_call"